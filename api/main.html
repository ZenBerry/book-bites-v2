<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5, user-scalable=no">
  <title>BookBites</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: sans-serif;
      text-align: center;
      background-color: #f5f5f5;
    }
    .quote-box-container {
      position: relative;
    }
    #loading {
      opacity: 0;
      transition: opacity 0.5s ease;
      position: absolute;
      font-size: 1.2rem;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .quote-box {
      max-width: 700px;
      padding: 40px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      opacity: 0;
      transition: opacity 0.5s ease;
      display: flex;
      gap: 20px;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .quote-text { font-size: 1.2rem; }
    .quote-author { font-weight: bold; font-size: 1rem; }
    .quote-book { font-style: italic; font-size: 0.9rem; }
    .quote-author:empty, .quote-book:empty { display: none; }

    .btn {
      display: flex;
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      background: white;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      opacity: 0;
      transition: opacity 0.5s ease;
      font-family: sans-serif !important;
      align-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 7px;
    }
    .btn-top-row {
      position: relative;
      min-width: 120px;
      justify-content: center;
    }
    .btn-prev {
      left: -120px;
      top: 50%;
      transform: translateY(-50%);
    }
    .btn-next {
      right: -120px;
      top: 50%;
      transform: translateY(-50%);
    }
    .dots {
      display: flex;
      gap: 6px;
      margin-top: 25px;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #ccc;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .dot.active { background-color: black; }
    .keycap {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 20px;
      height: 20px;
      border: 2px solid black;
      border-radius: 5px;
      background: transparent;
      font-size: 12px;
      user-select: none;
      font-family: -apple-system, "system-ui", "Segoe UI Adjusted", "Segoe UI", "Liberation Sans", sans-serif;
      font-weight: bold;
    }
    .keycap-return { position: relative; }
    .keycap-return::after {
      content: "";
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 16px;
      height: 16px;
      background: no-repeat center/contain;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='black'><path d='M19 7v4H6.83l3.58-3.59L9 6l-6 6 6 6 1.41-1.41L6.83 13H21V7z'/></svg>");
    }
    body.zen #topButtonsRow,
    body.zen .btn-prev,
    body.zen .btn-next,
    body.zen .dots {
      opacity: 0 !important;
    }
  </style>
</head>
<body>
  <div id="loading">Loading...</div>
  <div class="quote-box-container">
    <div id="topButtonsRow" style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 20px; transition: opacity 0.5s ease;">
      <button id="btn-home" class="btn btn-top-row"><div class="keycap">⏎</div>Find</button>
      <button id="btn-related" class="btn btn-top-row"><div class="keycap">M</div>More</button>
      <button class="btn btn-top-row"><div class="keycap">Z</div>Zen</button>
    </div>
    <div class="quote-box">
      <button class="btn btn-prev"><div class="keycap">←</div>Prev</button>
      <button class="btn btn-next">Next<div class="keycap">→</div></button>
      <div class="quote-text"></div>
      <div class="quote-author"></div>
      <div class="quote-book"></div>
    </div>
    <div class="dots"></div>
  </div>

  <script>
    console.log('v 2.5');
    let zenMode = false;
    const params = new URLSearchParams(window.location.search);
    const query = params.get('q') || 'Jasper Fforde';
    let quotes = [];
    let index = 0;

    const quoteBox = document.querySelector('.quote-box');
    const topButtonsRow = document.querySelector('#topButtonsRow');
    const quoteText = document.querySelector('.quote-text');
    const quoteAuthor = document.querySelector('.quote-author');
    const quoteBook = document.querySelector('.quote-book');
    const dotsContainer = document.querySelector('.dots');
    const buttons = document.querySelectorAll('.btn');

    async function fetchQuotes() {
      document.getElementById('loading').innerHTML = "Loading...";
      setTimeout(() => document.getElementById('loading').style.opacity = 1, 10);
      const response = await fetch(`/quotes?q=${encodeURIComponent(query)}`);
      quotes = await response.json();
      if (quotes.length > 0) {
        document.getElementById('loading').style.opacity = 0;
        createDots();
        fadeInAll();
        showQuote(true);
      } else {
        quoteText.textContent = "No quotes found.";
        fadeInAll();
      }
    }

    async function searchQuotes(term) {
      quoteBox.style.opacity = 0;
      dotsContainer.style.opacity = 0;
      buttons.forEach(btn => btn.style.opacity = 0);

      setTimeout(async () => {
        document.getElementById('loading').innerHTML = `Searching "${term}"...`;
        document.getElementById('loading').style.opacity = 1;

        try {
          const response = await fetch(`/quotes?q=${encodeURIComponent(term)}`);
          quotes = await response.json();
          index = 0;

          if (quotes.length > 0) {
            createDots();
            showQuote(true);
          } else {
            quoteText.textContent = `No quotes found for "${term}".`;
          }

          document.getElementById('loading').style.opacity = 0;
          quoteBox.style.opacity = 1;
          dotsContainer.style.opacity = 1;
          topButtonsRow.style.opacity = 1;
          buttons.forEach(btn => btn.style.opacity = 1);

          const newUrl = new URL(window.location);
          newUrl.searchParams.set('q', term);
          window.history.pushState({}, '', newUrl);
        } catch (err) {
          console.error("Error fetching quotes:", err);
          document.getElementById('loading').style.opacity = 0;
          quoteBox.style.opacity = 1;
          dotsContainer.style.opacity = 1;
          buttons.forEach(btn => btn.style.opacity = 1);
        }
      }, 500);
    }

    async function showRelated() {
      if (quotes.length === 0) return;
      const author = quotes[index].author;
      quoteBox.style.opacity = 0;
      dotsContainer.style.opacity = 0;
      topButtonsRow.style.opacity = 0;
      document.getElementById('loading').innerHTML = "Loading related...";
      document.getElementById('loading').style.opacity = 1;

      try {
        const res = await fetch(`/related?q=${encodeURIComponent(author)}`);
        const data = await res.json();
        quotesFromData = data.quotes;
        authorFromData = data.related_author;
        if (data.length === 0) return;

        setTimeout(() => {
          document.getElementById('loading').style.opacity = 0;
          quotes = quotesFromData;
          index = 0;
          createDots();
          showQuote(true);
          quoteBox.style.opacity = 1;
          dotsContainer.style.opacity = 1;
          topButtonsRow.style.opacity = 1;

          const newUrl = new URL(window.location);
          newUrl.searchParams.set('q', authorFromData);
          window.history.pushState({}, '', newUrl);
        }, 500);
      } catch (err) {
        console.error("Error fetching related quotes:", err);
        setTimeout(() => {
          quoteBox.style.opacity = 1;
          dotsContainer.style.opacity = 1;
          topButtonsRow.style.opacity = 1;
        }, 500);
      }
    }

    function fadeInAll() {
      quoteBox.style.opacity = 1;
      dotsContainer.style.opacity = 1;
      topButtonsRow.style.opacity = 1;
      buttons.forEach(btn => btn.style.opacity = 1);
    }

    function showQuote(initial = false) {
      if (quotes.length === 0) return;
      const q = quotes[index];
      if (initial) {
        quoteText.textContent = q.quote;
        quoteAuthor.textContent = q.author;
        quoteBook.textContent = q.book;
        updateDots();
      } else {
        quoteBox.style.opacity = 0;
        dotsContainer.style.opacity = 0;
        topButtonsRow.style.opacity = 0;
        setTimeout(() => {
          quoteText.textContent = q.quote;
          quoteAuthor.textContent = q.author;
          quoteBook.textContent = q.book;
          quoteBox.style.opacity = 1;
          dotsContainer.style.opacity = 1;
          topButtonsRow.style.opacity = 1;
          updateDots();
        }, 500);
      }
    }

    function createDots() {
      dotsContainer.innerHTML = '';
      quotes.forEach((_, i) => {
        const dot = document.createElement('div');
        dot.classList.add('dot');
        dot.addEventListener('click', () => {
          index = i;
          showQuote();
        });
        dotsContainer.appendChild(dot);
      });
    }

    function updateDots() {
      const dots = document.querySelectorAll('.dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    function nextQuote() {
      if (quotes.length === 0) return;
      index = (index + 1) % quotes.length;
      showQuote();
    }

    function prevQuote() {
      if (quotes.length === 0) return;
      index = (index - 1 + quotes.length) % quotes.length;
      showQuote();
    }

    function goHome() {
      const selection = window.getSelection().toString().trim();
      if (selection) {
        searchQuotes(selection);
      } else {
        quoteBox.style.opacity = 0;
        dotsContainer.style.opacity = 0;
        buttons.forEach(btn => btn.style.opacity = 0);
        setTimeout(() => {
          window.location.href = '/';
        }, 500);
      }
    }

    document.addEventListener('keydown', (e) => {
      switch(e.code) {
        case 'Space':
        case 'ArrowRight':
          e.preventDefault();
          nextQuote();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          prevQuote();
          break;
        case 'Enter':
          e.preventDefault();
          goHome();
          break;
        case 'KeyM':
          if (!e.metaKey && !e.ctrlKey) {
            e.preventDefault();
            showRelated();
            break;
          }
      }
    });

    document.querySelector('.btn-next').addEventListener('click', nextQuote);
    document.querySelector('.btn-prev').addEventListener('click', prevQuote);
    document.querySelector('#btn-home').addEventListener('click', goHome);
    document.querySelector('#btn-related').addEventListener('click', showRelated);

    fetchQuotes();

    function toggleZen() {
      zenMode = !zenMode;
      document.body.classList.toggle('zen', zenMode);
    }
    document.querySelector('#topButtonsRow button:nth-child(3)').addEventListener('click', toggleZen);
    document.addEventListener('keydown', (e) => {
      if (e.code === 'KeyZ' && !e.metaKey && !e.ctrlKey) {
        e.preventDefault();
        toggleZen();
      }
    });
  </script>
</body>
</html>
